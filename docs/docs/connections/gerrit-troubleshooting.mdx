---
title: Gerrit Authentication Troubleshooting Guide
sidebarTitle: Gerrit Troubleshooting
---

# Gerrit Authentication Troubleshooting Guide

This guide provides detailed troubleshooting steps for Gerrit authentication issues with Sourcebot, based on extensive testing and real-world scenarios.

## Quick Diagnosis

### Authentication Test Checklist

Run through this checklist to quickly identify authentication issues:

1. **✅ API Test**: Can you access Gerrit's API?
   ```bash
   curl -u "username:http-password" "https://gerrit.example.com/a/projects/"
   ```

2. **✅ Git Clone Test**: Can you clone manually?
   ```bash
   git clone https://username@gerrit.example.com/a/project-name
   ```

3. **✅ Project Access**: Do you have permissions for the project?
   ```bash
   curl -u "username:http-password" "https://gerrit.example.com/a/projects/project-name"
   ```

4. **✅ Environment Variable**: Is your password set correctly?
   ```bash
   echo $GERRIT_HTTP_PASSWORD
   ```

## Common Error Scenarios

### 1. Authentication Failed (401 Unauthorized)

**Error Signs:**
- Sourcebot logs show "401 Unauthorized"
- API tests fail with authentication errors
- Git clone fails with "Authentication failed"

**Root Causes & Solutions:**

<AccordionGroup>
    <Accordion title="Using Account Password Instead of HTTP Password">
        **Problem**: Using your regular Gerrit login password instead of the generated HTTP password.
        
        **Solution**:
        1. Generate a new HTTP password in Gerrit:
           - Go to Gerrit → Settings → HTTP Credentials
           - Click "Generate Password"
           - Copy the generated password (NOT your login password)
        2. Test the new password:
           ```bash
           curl -u "username:NEW_HTTP_PASSWORD" "https://gerrit.example.com/a/projects/"
           ```
    </Accordion>
    
    <Accordion title="Incorrect Username">
        **Problem**: Using display name or email instead of Gerrit username.
        
        **Solution**:
        1. Check your Gerrit username:
           - Go to Gerrit → Settings → Profile
           - Note the "Username" field (not display name)
        2. Common mistakes:
           - ❌ `john.doe@company.com` (email)
           - ❌ `John Doe` (display name)
           - ✅ `jdoe` (username)
    </Accordion>
    
    <Accordion title="Environment Variable Issues">
        **Problem**: Environment variable not set or incorrectly named.
        
        **Solution**:
        1. Check if variable is set:
           ```bash
           echo $GERRIT_HTTP_PASSWORD
           ```
        2. Set it correctly:
           ```bash
           export GERRIT_HTTP_PASSWORD="your-http-password"
           ```
        3. For Docker:
           ```bash
           docker run -e GERRIT_HTTP_PASSWORD="password" ...
           ```
    </Accordion>
</AccordionGroup>

### 2. No Projects Found (0 Repos Synced)

**Error Signs:**
- Sourcebot connects successfully but syncs 0 repositories
- Logs show "Upserted 0 repos for connection"
- No error messages, just empty results

**Root Causes & Solutions:**

<AccordionGroup>
    <Accordion title="Incorrect Project Names">
        **Problem**: Project names in config don't match actual Gerrit project names.
        
        **Solution**:
        1. List all accessible projects:
           ```bash
           curl -u "username:password" \
             "https://gerrit.example.com/a/projects/" | \
             jq 'keys[]'  # If jq is available
           ```
        2. Use exact project names from the API response
        3. For testing, try wildcard pattern:
           ```json
           "projects": ["*"]
           ```
    </Accordion>
    
    <Accordion title="Insufficient Permissions">
        **Problem**: User doesn't have clone permissions for specified projects.
        
        **Solution**:
        1. Check project-specific permissions in Gerrit admin
        2. Test access to a specific project:
           ```bash
           curl -u "username:password" \
             "https://gerrit.example.com/a/projects/project-name"
           ```
        3. Contact Gerrit admin to grant clone permissions
    </Accordion>
    
    <Accordion title="Hidden or Read-Only Projects">
        **Problem**: Projects are hidden or read-only and excluded by default.
        
        **Solution**:
        1. Include hidden/read-only projects explicitly:
           ```json
           {
               "type": "gerrit",
               "url": "https://gerrit.example.com",
               "projects": ["project-name"],
               "exclude": {
                   "hidden": false,    // Include hidden projects
                   "readOnly": false   // Include read-only projects
               }
           }
           ```
    </Accordion>
</AccordionGroup>

### 3. Git Clone Failures

**Error Signs:**
- Authentication works for API but fails for git operations
- "fatal: Authentication failed for" errors
- "remote: Unauthorized" messages

**Root Causes & Solutions:**

<AccordionGroup>
    <Accordion title="Missing /a/ Prefix">
        **Problem**: Git clone URL doesn't include the `/a/` prefix required for authenticated access.
        
        **Solution**:
        1. Verify correct URL format:
           - ❌ `https://username@gerrit.example.com/project-name`
           - ✅ `https://username@gerrit.example.com/a/project-name`
        2. Test manually:
           ```bash
           git clone https://username@gerrit.example.com/a/project-name
           ```
    </Accordion>
    
    <Accordion title="Git Credential Helper Issues">
        **Problem**: Git is using cached credentials or wrong credential helper.
        
        **Solution**:
        1. Clear Git credential cache:
           ```bash
           git credential-manager-core erase
           # Or for older systems:
           git credential-cache exit
           ```
        2. Test with explicit credentials:
           ```bash
           git -c credential.helper= clone https://username@gerrit.example.com/a/project
           ```
    </Accordion>
    
    <Accordion title="Special Characters in Passwords">
        **Problem**: HTTP passwords containing special characters (`/`, `+`, `=`) cause authentication failures.
        
        **Solution**:
        1. **For Sourcebot**: No action needed - URL encoding is handled automatically
        2. **For manual testing**: URL-encode the password:
           ```bash
           # Original password: pass/with+special=chars
           # URL-encoded: pass%2Fwith%2Bspecial%3Dchars
           git clone https://user:pass%2Fwith%2Bspecial%3Dchars@gerrit.example.com/a/project
           ```
        3. **For curl testing**:
           ```bash
           curl -u "username:pass/with+special=chars" "https://gerrit.example.com/a/projects/"
           ```
        
        <Note>
        Sourcebot v4.5.0+ automatically handles URL encoding for git operations. Earlier versions may require manual password encoding.
        </Note>
    </Accordion>
</AccordionGroup>

### 4. Configuration Schema Errors

**Error Signs:**
- "Config file is invalid" errors
- "must NOT have additional properties" messages
- Schema validation failures

**Root Causes & Solutions:**

<AccordionGroup>
    <Accordion title="Incorrect Auth Object Structure">
        **Problem**: Authentication configuration doesn't match expected schema.
        
        **Solution**:
        1. Use correct auth structure:
           ```json
           "auth": {
               "username": "your-username",
               "password": {
                   "env": "GERRIT_HTTP_PASSWORD"
               }
           }
           ```
        2. Common mistakes:
           ```json
           // ❌ Wrong - password as string
           "auth": {
               "username": "user",
               "password": "direct-password"
           }
           
           // ❌ Wrong - missing auth wrapper
           "username": "user",
           "password": {"env": "VAR"}
           ```
    </Accordion>
    
    <Accordion title="Extra Properties in Configuration">
        **Problem**: Configuration includes properties not in the schema.
        
        **Solution**:
        1. Check allowed properties in schema
        2. Remove any extra fields not in the official schema
        3. Validate configuration:
           ```bash
           # Use JSON schema validator if available
           jsonschema -i config.json schemas/v3/gerrit.json
           ```
    </Accordion>
</AccordionGroup>

## Advanced Troubleshooting

### Network and Connectivity Issues

<AccordionGroup>
    <Accordion title="SSL/TLS Certificate Problems">
        **Problem**: SSL certificate validation failures.
        
        **Solution**:
        1. Test with curl to verify SSL:
           ```bash
           curl -v "https://gerrit.example.com"
           ```
        2. For self-signed certificates (not recommended for production):
           ```bash
           git -c http.sslVerify=false clone https://...
           ```
        3. Install proper certificates on the system
    </Accordion>
    
    <Accordion title="Proxy and Firewall Issues">
        **Problem**: Corporate proxy or firewall blocking connections.
        
        **Solution**:
        1. Configure git proxy:
           ```bash
           git config --global http.proxy http://proxy.company.com:8080
           ```
        2. Test direct connection vs proxy:
           ```bash
           curl --proxy http://proxy:8080 "https://gerrit.example.com/a/projects/"
           ```
    </Accordion>
</AccordionGroup>

### Debugging Tools and Scripts

#### Complete Authentication Test Script

Save as `gerrit-debug.ts` and run with `ts-node`:

```typescript
import * as https from 'https';
import * as child_process from 'child_process';
import * as url from 'url';

// Configuration
const GERRIT_URL = 'https://gerrit.example.com';
const USERNAME = 'your-username';
const HTTP_PASSWORD = 'your-http-password';
const TEST_PROJECT = 'test-project-name';

console.log('🔍 Gerrit Authentication Debug Tool\n');

// Test 1: API Authentication
console.log('1️⃣ Testing API Authentication...');
const auth = 'Basic ' + Buffer.from(`${USERNAME}:${HTTP_PASSWORD}`).toString('base64');
const parsedUrl = new url.URL(GERRIT_URL);
const options: https.RequestOptions = {
    hostname: parsedUrl.hostname,
    port: parsedUrl.port || 443,
    path: '/a/projects/',
    method: 'GET',
    headers: {
        'Authorization': auth,
        'Accept': 'application/json'
    }
};

https.request(options, (res) => {
    console.log(`   Status: ${res.statusCode}`);
    if (res.statusCode === 200) {
        console.log('   ✅ API authentication successful');
        
        let data = '';
        res.on('data', chunk => data += chunk);
        res.on('end', () => {
            // Remove JSON prefix that Gerrit sometimes adds
            const cleanData = data.replace(/^\)\]\}'\n/, '');
            try {
                const projects = JSON.parse(cleanData);
                const projectCount = Object.keys(projects).length;
                console.log(`   📊 Found ${projectCount} accessible projects`);
                
                if (projectCount > 0) {
                    console.log('   📋 First 5 projects:');
                    Object.keys(projects).slice(0, 5).forEach(project => {
                        console.log(`      - ${project}`);
                    });
                }
            } catch (e) {
                console.log('   ⚠️  Could not parse project list');
            }
        });
    } else {
        console.log('   ❌ API authentication failed');
    }
}).on('error', (err) => {
    console.log(`   ❌ API request failed: ${err.message}`);
}).end();

// Test 2: Git Clone Test
console.log('\n2️⃣ Testing Git Clone...');
const cloneUrl = `https://${USERNAME}@${parsedUrl.host}/a/${TEST_PROJECT}`;
console.log(`   URL: ${cloneUrl}`);

// Note: This is a simplified test - in practice you'd need proper credential handling
console.log('   ℹ️  Manual test: git clone ' + cloneUrl);

// Test 3: Environment Variables
console.log('\n3️⃣ Checking Environment...');
console.log(`   NODE_ENV: ${process.env.NODE_ENV || 'not set'}`);
console.log(`   GERRIT_HTTP_PASSWORD: ${process.env.GERRIT_HTTP_PASSWORD ? 'set (length: ' + process.env.GERRIT_HTTP_PASSWORD.length + ')' : 'not set'}`);

console.log('\n🔍 Debug complete!');
```

#### Sourcebot Log Analysis

Look for these specific log patterns:

```bash
# Authentication success
grep "API authentication successful" sourcebot.log

# Project discovery
grep "Found .* accessible projects" sourcebot.log

# Git clone operations
grep "git clone" sourcebot.log

# Error patterns
grep -E "(401|unauthorized|authentication)" sourcebot.log -i
```

## Prevention and Best Practices

### Security Best Practices

1. **Credential Management**:
   - Never commit HTTP passwords to version control
   - Use environment variables or secret management systems
   - Rotate HTTP passwords regularly

2. **Least Privilege**:
   - Create dedicated service accounts for Sourcebot
   - Grant minimal necessary permissions
   - Monitor access logs

3. **Testing**:
   - Always test authentication manually before configuring Sourcebot
   - Keep backup authentication methods
   - Document working configurations

### Configuration Templates

#### Development Environment
```json
{
    "connections": {
        "dev-gerrit": {
            "type": "gerrit",
            "url": "https://gerrit-dev.company.com",
            "projects": ["dev-*"],
            "auth": {
                "username": "sourcebot-dev",
                "password": {
                    "env": "GERRIT_DEV_PASSWORD"
                }
            }
        }
    }
}
```

#### Production Environment
```json
{
    "connections": {
        "prod-gerrit": {
            "type": "gerrit",
            "url": "https://gerrit.company.com",
            "projects": [
                "critical-project",
                "team-alpha/**"
            ],
            "exclude": {
                "projects": ["**/archived/**"],
                "hidden": true,
                "readOnly": true
            },
            "auth": {
                "username": "sourcebot-prod",
                "password": {
                    "env": "GERRIT_PROD_PASSWORD"
                }
            }
        }
    }
}
```

## Getting Help

If you've followed this troubleshooting guide and still encounter issues:

1. **Gather Debug Information**:
   - Sourcebot logs with timestamps
   - Your configuration (with credentials redacted)
   - Gerrit version and authentication method
   - Network topology (proxy, firewall, etc.)

2. **Test Manually**:
   - Run the debug script above
   - Document exact error messages
   - Note which step fails

3. **Report Issues**:
   - [Open a GitHub issue](https://github.com/sourcebot-dev/sourcebot/issues)
   - Include debug information
   - Describe expected vs actual behavior

4. **Community Support**:
   - [Join discussions](https://github.com/sourcebot-dev/sourcebot/discussions)
   - Search existing issues for similar problems
   - Share solutions that work for your environment

---

<Note>
This troubleshooting guide is based on real-world testing and user reports. It will be updated as new scenarios are discovered and resolved.
</Note> 